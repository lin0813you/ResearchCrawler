# å¾Œç«¯é‡æ§‹æ¶æ§‹è¨­è¨ˆæ–‡æª”

## ğŸ¯ è¨­è¨ˆç›®æ¨™

1. **æ¸…æ™°åˆ†å±¤**: çˆ¬èŸ²é‚è¼¯ã€æ•¸æ“šæ¨¡å‹ã€API å±¤å„å¸å…¶è·
2. **å¯æ“´å±•æ€§**: æ˜“æ–¼å¢åŠ æ–°çš„ API ç«¯é»å’ŒåŠŸèƒ½
3. **æ˜“æ–¼æ¸¬è©¦**: å„å±¤ç¨ç«‹ï¼Œä¾¿æ–¼å–®å…ƒæ¸¬è©¦
4. **å¿«é€ŸæŸ¥è©¢**: ä½¿ç”¨å¿«å–æ”¯æŒ plan_name ç›´æ¥æŸ¥è©¢

## ğŸ“Š æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (Vue/React)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    HTTP/REST
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    FastAPI æ‡‰ç”¨å±¤ (main.py)     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚   Route Handlers         â”‚  â”‚
        â”‚  â”‚ - GET /api/health        â”‚  â”‚
        â”‚  â”‚ - GET /api/awards        â”‚  â”‚
        â”‚  â”‚ - GET /api/awards/{name} â”‚  â”‚
        â”‚  â”‚ - GET /api/awards/detail â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚             â”‚                   â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚  å¿«å–å±¤ (Dict/Redis)    â”‚   â”‚
        â”‚  â”‚  Key: plan_name         â”‚   â”‚
        â”‚  â”‚  Value: Award List      â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   çˆ¬èŸ²å±¤ (crawler.py)          â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚  NSTCAwardClient         â”‚ â”‚
        â”‚  â”‚ - search_awards()        â”‚ â”‚
        â”‚  â”‚ - fetch_impact_detail()  â”‚ â”‚
        â”‚  â”‚ - HTML è§£æé‚è¼¯          â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚             â”‚                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚  TLS12Adapter (HTTPS)    â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  NSTC å®˜æ–¹ç¶²ç«™                     â”‚
        â”‚  https://wsts.nstc.gov.tw/...     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•¸æ“šæ¨¡å‹å±¤ (models.py)                   â”‚
â”‚                                                             â”‚
â”‚  @dataclass AwardItem                                      â”‚
â”‚  â”œâ”€ award_year: str                                       â”‚
â”‚  â”œâ”€ pi_name: str                                          â”‚
â”‚  â”œâ”€ organ: str                                            â”‚
â”‚  â”œâ”€ plan_name: str â­ å¿«å– Key                            â”‚
â”‚  â”œâ”€ period: str                                           â”‚
â”‚  â”œâ”€ total_amount: str                                     â”‚
â”‚  â”œâ”€ impact: str                                           â”‚
â”‚  â”œâ”€ keywords_zh: str                                      â”‚
â”‚  â”œâ”€ keywords_en: str                                      â”‚
â”‚  â””â”€ project_no: Optional[str] â­ è©³æƒ…æŸ¥è©¢                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•¸æ“šæµç¨‹

### æµç¨‹ 1: æŸ¥è©¢çé … (GET /api/awards)

```
å‰ç«¯æŸ¥è©¢è«‹æ±‚
    â”‚
    â–¼
FastAPI è·¯ç”±è™•ç† (search_awards)
    â”‚
    â”œâ”€ é©—è­‰æŸ¥è©¢åƒæ•¸
    â”‚
    â–¼
NSTCAwardClient.search_awards()
    â”‚
    â”œâ”€ æ§‹å»ºæŸ¥è©¢ URL
    â”œâ”€ ç™¼é€ HTTPS è«‹æ±‚
    â”œâ”€ è§£æ HTML é é¢
    â”œâ”€ æå–çé …ä¿¡æ¯
    â”‚
    â–¼
æ§‹å»º AwardItem å°è±¡
    â”‚
    â–¼
å­˜å…¥å¿«å– (plan_name â†’ data)
    â”‚
    â–¼
è¿”å› JSON éŸ¿æ‡‰
    â”‚
    â–¼
å‰ç«¯æ¥æ”¶ä¸¦å±•ç¤º
```

### æµç¨‹ 2: æ ¹æ“šè¨ˆç•«åç¨±æŸ¥è©¢ (GET /api/awards/{plan_name})

```
å‰ç«¯æ ¹æ“š plan_name æŸ¥è©¢
    â”‚
    â–¼
FastAPI è·¯ç”±è™•ç†
    â”‚
    â”œâ”€ æª¢æŸ¥å¿«å–ä¸­æ˜¯å¦å­˜åœ¨ plan_name
    â”‚  â”œâ”€ å­˜åœ¨ âœ“ â†’ ç›´æ¥è¿”å›
    â”‚  â””â”€ ä¸å­˜åœ¨ âœ— â†’ è¿”å› 404
    â”‚
    â–¼
è¿”å› JSON éŸ¿æ‡‰
    â”‚
    â–¼
å‰ç«¯æ¥æ”¶ä¸¦å±•ç¤º
```

### æµç¨‹ 3: ç²å–è¨ˆç•«è©³ç´°ä¿¡æ¯ (GET /api/awards/detail/{project_no})

```
å‰ç«¯æ ¹æ“š project_no æŸ¥è©¢è©³æƒ…
    â”‚
    â–¼
FastAPI è·¯ç”±è™•ç†
    â”‚
    â–¼
NSTCAwardClient.fetch_impact_detail()
    â”‚
    â”œâ”€ æ§‹å»ºè©³æƒ… URL
    â”œâ”€ ç™¼é€ HTTPS è«‹æ±‚
    â”œâ”€ è§£æè©³æƒ…é é¢
    â”œâ”€ æå–å®Œæ•´è¨ˆç•«æ¦‚è¿°
    â”‚
    â–¼
è¿”å› JSON éŸ¿æ‡‰
    â”‚
    â–¼
å‰ç«¯æ¥æ”¶ä¸¦å±•ç¤º
```

## ğŸ”‘ æ ¸å¿ƒè¨­è¨ˆæ±ºç­–

### 1. ç‚ºä»€éº¼åˆ†æˆå¤šå€‹æ–‡ä»¶ï¼Ÿ

| æ–‡ä»¶         | è·è²¬           | å„ªé»                       |
| ------------ | -------------- | -------------------------- |
| `models.py`  | æ•¸æ“šæ¨¡å‹å®šç¾©   | æ¸…æ™°çš„æ•¸æ“šçµæ§‹ï¼Œæ˜“æ–¼ç¶­è­·   |
| `crawler.py` | çˆ¬èŸ²é‚è¼¯       | æ¥­å‹™é‚è¼¯é›†ä¸­ï¼Œæ˜“æ–¼å–®ç¨æ¸¬è©¦ |
| `main.py`    | API è·¯ç”±å’Œå¿«å– | é—œæ³¨ HTTP å±¤ï¼Œæ˜“æ–¼æ“´å±•ç«¯é» |
| `config.py`  | é…ç½®ç®¡ç†       | æ–¹ä¾¿éƒ¨ç½²å’Œç’°å¢ƒåˆ‡æ›         |

### 2. ç‚ºä»€éº¼ä½¿ç”¨å¿«å–ï¼Ÿ

- **æ€§èƒ½**: é¿å…é‡è¤‡çˆ¬å–ç›¸åŒæ•¸æ“š
- **éŸ¿æ‡‰é€Ÿåº¦**: plan_name æŸ¥è©¢ O(1) æ™‚é–“è¤‡é›œåº¦
- **ç”¨æˆ¶é«”é©—**: å¿«é€ŸéŸ¿æ‡‰

**æœªä¾†å„ªåŒ–**:

- ä½¿ç”¨ Redis æ›¿ä»£å…§å­˜å¿«å–ï¼ˆåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰
- æ·»åŠ å¿«å–éæœŸæ™‚é–“
- æ•¸æ“šåº«æŒä¹…åŒ–

### 3. plan_name ä½œç‚ºè·¯ç”±åƒæ•¸çš„å„ªå‹¢

```javascript
// å‰ç«¯ä½¿ç”¨ç¤ºä¾‹
const planName = "ç§‘æŠ€éƒ¨ç”¢å­¸åˆä½œè¨ˆç•«";
const url = `/api/awards/${encodeURIComponent(planName)}`;
const response = await fetch(url);
```

å¥½è™•ï¼š

- ç¬¦åˆ RESTful è¨­è¨ˆ
- URL èªç¾©æ¸…æ™°
- æ˜“æ–¼å‰ç«¯é›†æˆ

## ğŸ“¦ æ¨¡å¡Šèªªæ˜

### models.py - æ•¸æ“šæ¨¡å‹

```python
@dataclass
class AwardItem:
    # åŸºæœ¬ä¿¡æ¯
    award_year: str       # æ°‘åœ‹å¹´ä»½
    pi_name: str          # ä¸»æŒäºº
    organ: str            # æ©Ÿæ§‹

    # è¨ˆç•«ä¿¡æ¯ï¼ˆæ ¸å¿ƒï¼‰
    plan_name: str        # â­ è¨ˆç•«åç¨±
    period: str           # åŸ·è¡ŒæœŸé™
    total_amount: str     # ç¶“è²»

    # è©³ç´°ä¿¡æ¯
    impact: str           # è¨ˆç•«æ¦‚è¿°
    keywords_zh: str      # ä¸­æ–‡é—œéµå­—
    keywords_en: str      # è‹±æ–‡é—œéµå­—
    project_no: Optional[str]  # â­ è¨ˆç•«ç·¨è™Ÿ
```

### crawler.py - çˆ¬èŸ²é‚è¼¯

**æ ¸å¿ƒæ–¹æ³•:**

| æ–¹æ³•                        | ç”¨é€”                   |
| --------------------------- | ---------------------- |
| `search_awards()`           | æŸ¥è©¢ç¬¦åˆæ¢ä»¶çš„çé …åˆ—è¡¨ |
| `fetch_impact_detail()`     | ç²å–è¨ˆç•«è©³ç´°ä¿¡æ¯       |
| `_extract_project_no()`     | å¾ HTML æå–è¨ˆç•«ç·¨è™Ÿ   |
| `_has_impact_detail_link()` | åˆ¤æ–·æ˜¯å¦æœ‰è©³æƒ…éˆæ¥     |

### main.py - API æ‡‰ç”¨

**è·¯ç”±ç«¯é»:**

| ç«¯é»                              | æ–¹æ³• | åƒæ•¸             | å¿«å–   |
| --------------------------------- | ---- | ---------------- | ------ |
| `/api/health`                     | GET  | -                | âœ“      |
| `/api/awards`                     | GET  | year, code, name | âœ“ å¯«å…¥ |
| `/api/awards/{plan_name}`         | GET  | -                | âœ“ è®€å– |
| `/api/awards/detail/{project_no}` | GET  | -                | -      |

## ğŸ› ï¸ æ“´å±•æŒ‡å—

### æ·»åŠ æ–°çš„æŸ¥è©¢ç«¯é»

```python
@app.get("/api/awards/filter")
async def filter_awards(
    min_amount: Optional[int] = None,
    keywords: Optional[str] = None
):
    """æ ¹æ“šé‡‘é¡å’Œé—œéµå­—éæ¿¾"""
    # å¯¦ç¾é‚è¼¯...
    pass
```

### æ·»åŠ æ•¸æ“šåº«æ”¯æŒ

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# åœ¨ main.py ä¸­
engine = create_engine("sqlite:///./awards.db")
SessionLocal = sessionmaker(bind=engine)

@app.get("/api/awards")
async def search_awards(...):
    db = SessionLocal()
    # å¾æ•¸æ“šåº«æŸ¥è©¢è€Œä¸æ˜¯çˆ¬èŸ²
    results = db.query(AwardDB).filter(...).all()
    db.close()
    return results
```

### æ·»åŠ å¾Œå°çˆ¬èŸ²ä»»å‹™

```python
from celery import Celery

celery_app = Celery("crawler", broker="redis://localhost")

@celery_app.task
def crawl_awards_async(year, code, name):
    """ç•°æ­¥çˆ¬èŸ²ä»»å‹™"""
    result = crawler_client.search_awards(...)
    # å­˜å„²åˆ°æ•¸æ“šåº«æˆ–å¿«å–
    return result
```

## ğŸ“ˆ æ€§èƒ½è€ƒæ…®

### ç•¶å‰ç“¶é ¸

1. **ç¶²çµ¡å»¶é²**: çˆ¬èŸ²ä¾è³´å¤–éƒ¨ç¶²ç«™

   - è§£æ±º: æ·»åŠ å¿«å–ã€å¢åŠ è¶…æ™‚æ™‚é–“

2. **ä¸¦ç™¼é™åˆ¶**: å–®ç·šç¨‹çˆ¬èŸ²

   - è§£æ±º: ä½¿ç”¨ Celery ç•°æ­¥ä»»å‹™

3. **å…§å­˜å ç”¨**: å…¨é‡å¿«å–
   - è§£æ±º: ä½¿ç”¨ Redisã€æ·»åŠ  LRU ç­–ç•¥

### å„ªåŒ–å»ºè­°

```python
# 1. æ·»åŠ éŸ¿æ‡‰å¿«å–
from fastapi_cache2 import FastAPICache2
from fastapi_cache2.backends.redis import RedisBackend

@app.get("/api/awards", response_model=List[dict])
@cached(expire=3600)  # 1å°æ™‚éæœŸ
async def search_awards(...):
    pass

# 2. å¯¦ç¾é€Ÿç‡é™åˆ¶
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.get("/api/awards")
@limiter.limit("100/minute")  # æ¯åˆ†é˜ 100 å€‹è«‹æ±‚
async def search_awards(...):
    pass
```

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦

```python
# test_crawler.py
def test_search_awards():
    client = NSTCAwardClient()
    awards = client.search_awards(year=113, code="QS01", name="test")
    assert isinstance(awards, list)
    assert all(isinstance(a, AwardItem) for a in awards)

# test_models.py
def test_award_item_to_response():
    item = AwardItem(...)
    response = item.to_response()
    assert "plan_name" in response
```

### é›†æˆæ¸¬è©¦

```python
# test_api.py
from fastapi.testclient import TestClient

client = TestClient(app)

def test_health():
    response = client.get("/api/health")
    assert response.status_code == 200

def test_search_awards():
    response = client.get("/api/awards?year=113&code=QS01&name=test")
    assert response.status_code in [200, 404]
```

## ğŸ“‹ ç™¼ä½ˆæ¸…å–®

- [x] çˆ¬èŸ²é‚è¼¯é‡æ§‹
- [x] API è·¯ç”±å®šç¾©
- [x] å¿«å–æ©Ÿåˆ¶å¯¦ç¾
- [x] CORS é…ç½®
- [x] API æ–‡æª”ï¼ˆSwaggerï¼‰
- [x] æ¸¬è©¦è…³æœ¬
- [x] å•Ÿå‹•è…³æœ¬
- [ ] å–®å…ƒæ¸¬è©¦
- [ ] å‰ç«¯é›†æˆ
- [ ] æ•¸æ“šåº«é›†æˆ
- [ ] éƒ¨ç½²æŒ‡å—

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2024 å¹´ 12 æœˆ
